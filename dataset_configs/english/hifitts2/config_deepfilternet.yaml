documentation: |
  HiFiTTS-2 48kHz with DeepFilterNet Trim (Bucket-Mounted)
  ########################################################
  
  This config downloads and processes HiFiTTS-2 audio data at 48kHz, writing directly to a
  GCS bucket mounted with gcsfuse to avoid local storage limitations.
  
  1. Downloads HiFiTTS-2 audio from LibriVox at 48kHz.
  2. Writes audio files directly to mounted bucket (no local accumulation).
  3. Trims silence using DeepFilterNet's energy-based method (modifies files on bucket).
  4. Outputs a new manifest in which LibriVox audiobook chapters which could not be downloaded
     (e.g. because they were removed from the website) are removed.

  **Required setup**:
  
  1. Mount your bucket with gcsfuse:
     ```bash
     gcsfuse hifitts-2-dataset ~/NeMo-speech-data-processor/dataset
     ```
  
  2. **workspace_dir**: Local folder for manifests and temporary chapter files.
  3. **bucket_mount_path**: Path where bucket is mounted (default: ~/NeMo-speech-data-processor/dataset).

  Note that you can customize any part of this config either directly or from command-line.
 
  **Output format**.

  This config outputs 2 manifest files:

  * ``${workspace_dir}/errors.json`` - entries from the input chapters file which failed to download from LibriVox.
  * ``${workspace_dir}/manifest_filtered_44khz`` - input manifest file without utterances from failed chapters (trimmed).
  
  Audio files are written directly to the mounted bucket at ``${bucket_mount_path}/${audio_dir_name}``.

processors_to_run: all
workspace_dir: ~/NeMo-speech-data-processor/workspace
# Mount your bucket with: gcsfuse hifitts-2-dataset ~/NeMo-speech-data-processor/dataset
bucket_mount_path: ~/NeMo-speech-data-processor/dataset
manifest_filename: manifest_44khz.json
output_filename: manifest_filtered_44khz.json
chapter_filename: chapters_44khz.json
error_filename: errors_44khz.json
audio_dir_name: audio_44khz
chapter_audio_dir_name: chapters
sample_rate: 48000
delete_chapter_files: true
exit_on_error: false
use_dask: false
max_workers: 4  # Optimized for n2-standard-4 (4 vCPUs)
chunksize: 50

input_manifest_file: ${workspace_dir}/${manifest_filename}
chapter_file: ${workspace_dir}/${chapter_filename}
error_file: ${workspace_dir}/${error_filename}
# audio_dir points to mounted bucket - files written directly to bucket
audio_dir: ${bucket_mount_path}/${audio_dir_name}
# chapter_dir stays local - chapters deleted after processing, minimal storage needed
chapter_dir: ${workspace_dir}/${chapter_audio_dir_name}
final_manifest: ${workspace_dir}/${output_filename}

processors:
  - _target_: sdp.processors.DownloadHiFiTTS2
    audio_dir: ${audio_dir}
    chapter_dir: ${chapter_dir}
    sample_rate: ${sample_rate}
    delete_chapter_files: ${delete_chapter_files}
    exit_on_error: ${exit_on_error}
    input_manifest_file: ${chapter_file}
    output_manifest_file: ${error_file}
    use_dask: ${use_dask}
    max_workers: ${max_workers}
    chunksize: ${chunksize}

  - _target_: sdp.processors.RemovedFailedChapters
    input_manifest_file: ${input_manifest_file}
    output_manifest_file: ${workspace_dir}/manifest_before_trim.json
    error_file: ${error_file}

  # Trim silence using DeepFilterNet's energy-based method
  # Files are on mounted bucket, so trimming happens directly on bucket
  - _target_: sdp.processors.TrimSilence
    input_manifest_file: ${workspace_dir}/manifest_before_trim.json
    output_manifest_file: ${final_manifest}
    audio_dir: ${audio_dir}
    input_audio_key: audio_filepath
    start_threshold_db: -120.0  # DeepFilterNet default
    end_threshold_db: -100.0    # DeepFilterNet default
    start_padding_frames: 15    # DeepFilterNet default
    end_padding_frames: 10      # DeepFilterNet default
    update_duration: true
    use_dask: ${use_dask}
    max_workers: ${max_workers}
    chunksize: ${chunksize}
